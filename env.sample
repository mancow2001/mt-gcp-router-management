# ============================================================================
# GCP Route Management Daemon - Configuration
# ============================================================================
# This file contains all configurable environment variables for the daemon.
# Copy this file to .env and customize for your environment.
#
# Required variables are marked with [REQUIRED]
# Optional variables show their default values

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================

# Logger name (shown in log messages)
LOGGER_NAME=CENTRAL_RAD_HC

# Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# Standard log file path
LOG_FILE=/var/log/radius_healthcheck_daemon.log

# Log rotation settings
LOG_MAX_BYTES=10485760        # 10MB (default)
LOG_BACKUP_COUNT=5            # Number of backup files to keep (default)

# Enable Google Cloud Logging (Stackdriver)
ENABLE_GCP_LOGGING=false

# Structured logging options
# Output structured JSON logs to console
ENABLE_STRUCTURED_CONSOLE=false

# Output structured JSON logs to separate file (recommended for production)
ENABLE_STRUCTURED_FILE=true
STRUCTURED_LOG_FILE=/var/log/radius_healthcheck_daemon_structured.json

# ============================================================================
# GCP CONFIGURATION
# ============================================================================

# [REQUIRED] GCP project ID where backend services and routers are located
GCP_PROJECT=radius-core-dev-18c6

# [REQUIRED] GCP regions to monitor
LOCAL_GCP_REGION=us-central1
REMOTE_GCP_REGION=us-east4

# ============================================================================
# GCP AUTHENTICATION
# ============================================================================
# Choose ONE of the following authentication methods:
#
# METHOD 1: Workload Identity Federation / Application Default Credentials (RECOMMENDED)
# ─────────────────────────────────────────────────────────────────────────
# Benefits:
#   - No long-lived service account keys to manage
#   - Automatic credential rotation
#   - Reduced attack surface
#   - Better audit trails
#   - Follows Google Cloud security best practices
#
# Use cases:
#   - Running on GKE (Google Kubernetes Engine)
#   - Running on GCE (Compute Engine VM)
#   - Running on Cloud Run, Cloud Functions
#   - Local development with gcloud auth application-default login
#
# Setup:
#   1. Set USE_WORKLOAD_IDENTITY=true
#   2. Do NOT set GOOGLE_APPLICATION_CREDENTIALS
#   3. Configure Workload Identity binding (see README.md)
#
# USE_WORKLOAD_IDENTITY=true
#
# ─────────────────────────────────────────────────────────────────────────
# METHOD 2: Service Account Key File (LEGACY)
# ─────────────────────────────────────────────────────────────────────────
# Benefits:
#   - Simple setup for local development and testing
#   - Works anywhere (on-premises, other clouds)
#
# Drawbacks:
#   - Requires manual key rotation
#   - Key files must be stored securely
#   - Higher security risk if key is compromised
#
# Setup:
#   1. Set USE_WORKLOAD_IDENTITY=false
#   2. Set GOOGLE_APPLICATION_CREDENTIALS to path of service account JSON key
#   3. Ensure key file has permissions 600 (owner read/write only)
#
USE_WORKLOAD_IDENTITY=false
GOOGLE_APPLICATION_CREDENTIALS=key.json

# ============================================================================
# BGP ROUTER CONFIGURATION
# ============================================================================

# [REQUIRED] GCP project containing BGP routers (may differ from GCP_PROJECT)
BGP_PEER_PROJECT=radius-network-2e39

# [REQUIRED] Local BGP router (daemon manages BGP advertisements on this router)
LOCAL_BGP_REGION=us-central1
LOCAL_BGP_ROUTER=gc1-dev-ac-pi-col-ord-cr

# [REQUIRED] Remote BGP router (daemon monitors status only, does not modify)
REMOTE_BGP_REGION=us-east4
REMOTE_BGP_ROUTER=ge4-ac-dev-pi-col-ash-cr

# ============================================================================
# NETWORK PREFIX CONFIGURATION
# ============================================================================

# [REQUIRED] IPv4 network prefixes to advertise via BGP
# Must be valid CIDR notation (e.g., 10.0.0.0/24)
PRIMARY_PREFIX=10.137.245.0/25
SECONDARY_PREFIX=10.137.19.0/25

# OPTIONAL: Internal IP addresses associated with prefixes
# Used for advanced routing scenarios
# PRIMARY_INTERNAL_IP=10.137.245.1
# SECONDARY_INTERNAL_IP=10.137.19.1

# ============================================================================
# CLOUDFLARE MAGIC TRANSIT CONFIGURATION
# ============================================================================

# [REQUIRED] Cloudflare account ID
CLOUDFLARE_ACCOUNT_ID=bde69d6cd640966c7e9fc74fa72e3c44

# [REQUIRED] Cloudflare API token (requires Magic Transit permissions)
# Token permissions needed:
#   - Account:Read (for token verification)
#   - Zone:Zone Settings:Edit (for route management)
CLOUDFLARE_API_TOKEN=your-cloudflare-api-token-here

# [REQUIRED] Only update Cloudflare routes where description contains this substring
# This prevents accidental modification of unrelated routes
DESCRIPTION_SUBSTRING=CF-DEV-C

# Priority values for Cloudflare routes
# Lower values = higher priority
CLOUDFLARE_PRIMARY_PRIORITY=100
CLOUDFLARE_SECONDARY_PRIORITY=200

# ============================================================================
# DAEMON BEHAVIOR
# ============================================================================

# Health check interval (seconds)
# How often to check backend health and BGP status
# Range: 1-3600 (default: 60)
CHECK_INTERVAL_SECONDS=60

# Passive Mode - When set to TRUE, daemon monitors but does NOT make route changes
# Useful for:
#   - Testing and validation
#   - Dry-run deployments
#   - Auditing state transitions without impact
# Set to FALSE (default) to enable route updates
RUN_PASSIVE=FALSE

# ============================================================================
# ROUTE FLAPPING PROTECTION
# ============================================================================
# Three-layer protection system to prevent route oscillation

# Layer 1: Health Check Hysteresis
# ─────────────────────────────────────────────────────────────────────────
# Smooths out transient failures using a sliding window

# Number of recent health checks to track (range: 3-10, default: 5)
HEALTH_CHECK_WINDOW=5

# Minimum healthy checks required within window to consider region healthy
# Must be less than HEALTH_CHECK_WINDOW (range: 1-10, default: 3)
# Example: With window=5 and threshold=3, need 3/5 checks healthy
HEALTH_CHECK_THRESHOLD=3

# Asymmetric hysteresis mode (default: false)
# false: Same threshold for healthy→unhealthy and unhealthy→healthy transitions
# true:  Harder to change state - requires more evidence
#        - Stay in current state: 2/5 healthy
#        - Change state: 4/5 healthy
ASYMMETRIC_HYSTERESIS=false

# Layer 2: State Verification Thresholds
# ─────────────────────────────────────────────────────────────────────────
# Requires consecutive detections before taking action for critical states

# State 2 (Local unhealthy): Consecutive detections required (range: 1-10, default: 2)
STATE_2_VERIFICATION_THRESHOLD=2

# State 3 (Remote unhealthy): Consecutive detections required (range: 1-10, default: 2)
STATE_3_VERIFICATION_THRESHOLD=2

# State 4 (Both unhealthy): Consecutive detections required (range: 1-10, default: 2)
STATE_4_VERIFICATION_THRESHOLD=2

# Layer 3: Minimum State Dwell Time
# ─────────────────────────────────────────────────────────────────────────
# Prevents rapid state transitions

# Minimum seconds to remain in a state before allowing transitions
# Range: 30-600 (default: 120 = 2 minutes)
MIN_STATE_DWELL_TIME=120

# States that bypass dwell time requirement (comma-separated)
# State 1 (all healthy): Fast recovery
# State 4 (both unhealthy): Emergency response
# Default: 1,4
DWELL_TIME_EXCEPTION_STATES=1,4

# ============================================================================
# RETRY AND CIRCUIT BREAKER CONFIGURATION
# ============================================================================

# Per-Service Retry Limits
# ─────────────────────────────────────────────────────────────────────────
# Different operations have different retry strategies:
# - Read-only operations (health checks): Higher retries
# - Write operations (BGP updates): Lower retries to avoid duplicate changes

# Backend health checks (read-only, can retry more aggressively)
# Range: 1-10 (default: 5)
MAX_RETRIES_HEALTH_CHECK=5

# BGP session status checks (read-only)
# Range: 1-10 (default: 4)
MAX_RETRIES_BGP_CHECK=4

# BGP advertisement updates (modifies state, retry less)
# Range: 1-10 (default: 2)
MAX_RETRIES_BGP_UPDATE=2

# Cloudflare API calls (route priority updates)
# Range: 1-10 (default: 3)
MAX_RETRIES_CLOUDFLARE=3

# Legacy retry setting (deprecated, kept for backward compatibility)
# Use per-service settings above instead
MAX_RETRIES=3

# Exponential Backoff Configuration
# ─────────────────────────────────────────────────────────────────────────
# Initial backoff delay in seconds (range: 0.1-60, default: 1.0)
INITIAL_BACKOFF_SECONDS=1.0

# Maximum backoff delay in seconds (range: 1-600, default: 60)
MAX_BACKOFF_SECONDS=60

# Circuit Breaker Configuration
# ─────────────────────────────────────────────────────────────────────────
# Prevents cascading failures by stopping retries after repeated failures

# Number of consecutive failures before opening circuit (range: 1-20, default: 5)
CIRCUIT_BREAKER_THRESHOLD=5

# Seconds to wait before attempting to close circuit (range: 30-3600, default: 300 = 5 minutes)
CIRCUIT_BREAKER_TIMEOUT_SECONDS=300

# ============================================================================
# API TIMEOUT CONFIGURATION
# ============================================================================
# All values in seconds, range: 5-300

# General GCP API operations (default: 30)
GCP_API_TIMEOUT=30

# GCP backend health checks (may take longer due to instance checks)
# Default: 45
GCP_BACKEND_HEALTH_TIMEOUT=45

# GCP BGP operations (router updates can be slow)
# Default: 60
GCP_BGP_OPERATION_TIMEOUT=60

# Cloudflare API single request timeout (default: 10)
CLOUDFLARE_API_TIMEOUT=10

# Cloudflare bulk operations timeout (multiple route updates)
# Default: 60
CLOUDFLARE_BULK_TIMEOUT=60

# ============================================================================
# ADVANCED SETTINGS (Optional)
# ============================================================================

# These settings have sensible defaults and typically don't need to be changed

# Log rotation
# LOG_MAX_BYTES=10485760      # 10MB
# LOG_BACKUP_COUNT=5

# Structured logging
# ENABLE_STRUCTURED_CONSOLE=false
# ENABLE_STRUCTURED_FILE=true
# STRUCTURED_LOG_FILE=/var/log/radius_healthcheck_daemon_structured.json

# ============================================================================
# DEPLOYMENT EXAMPLES
# ============================================================================
#
# Example 1: GKE Production Deployment with Workload Identity
# ───────────────────────────────────────────────────────────
# USE_WORKLOAD_IDENTITY=true
# GCP_PROJECT=my-production-project
# LOCAL_GCP_REGION=us-central1
# REMOTE_GCP_REGION=us-east4
# RUN_PASSIVE=FALSE
# ENABLE_STRUCTURED_FILE=true
# ENABLE_GCP_LOGGING=true
#
# Example 2: Local Development with Service Account Key
# ───────────────────────────────────────────────────────────
# USE_WORKLOAD_IDENTITY=false
# GOOGLE_APPLICATION_CREDENTIALS=./keys/dev-service-account.json
# GCP_PROJECT=my-dev-project
# RUN_PASSIVE=TRUE              # Monitor only, don't make changes
# LOG_LEVEL=DEBUG
# ENABLE_STRUCTURED_CONSOLE=true
#
# Example 3: GCE VM with Attached Service Account
# ───────────────────────────────────────────────────────────
# USE_WORKLOAD_IDENTITY=true    # Uses VM's attached service account
# GCP_PROJECT=my-production-project
# CHECK_INTERVAL_SECONDS=30     # More frequent checks
# MIN_STATE_DWELL_TIME=180      # 3 minutes dwell time for stability
#
# ============================================================================
